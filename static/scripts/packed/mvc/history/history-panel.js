define(["mvc/list/list-panel","mvc/history/history-model","mvc/history/history-contents","mvc/history/hda-li","mvc/history/hdca-li","mvc/collection/collection-panel","mvc/user/user-model","ui/fa-icon-button","mvc/ui/popup-menu","mvc/base-mvc","utils/localization","ui/search-input"],function(f,h,n,d,b,o,i,c,a,q,g){var l=q.SessionStorageModel.extend({defaults:{expandedIds:{},show_deleted:false,show_hidden:false},addExpanded:function(r){var s="expandedIds";this.save(s,_.extend(this.get(s),_.object([r.id],[r.get("id")])))},removeExpanded:function(r){var s="expandedIds";this.save(s,_.omit(this.get(s),r.id))},toString:function(){return"HistoryPrefs("+this.id+")"}});l.storageKeyPrefix="history:";l.historyStorageKey=function j(r){if(!r){throw new Error("HistoryPrefs.historyStorageKey needs valid id: "+r)}return(l.storageKeyPrefix+r)};l.get=function e(r){return new l({id:l.historyStorageKey(r)})};l.clearAll=function k(s){for(var r in sessionStorage){if(r.indexOf(l.storageKeyPrefix)===0){sessionStorage.removeItem(r)}}};var p=f.ModelListPanel;var m=p.extend({HDAViewClass:d.HDAListItemView,HDCAViewClass:b.HDCAListItemView,collectionClass:n.HistoryContents,modelCollectionKey:"contents",tagName:"div",className:p.prototype.className+" history-panel",emptyMsg:g("This history is empty"),noneFoundMsg:g("No matching datasets found"),searchPlaceholder:g("search datasets"),initialize:function(r){p.prototype.initialize.call(this,r);this.linkTarget=r.linkTarget||"_blank"},freeModel:function(){p.prototype.freeModel.call(this);if(this.model){this.model.clearUpdateTimeout()}return this},_setUpListeners:function(){p.prototype._setUpListeners.call(this);this.on("error",function(s,v,r,u,t){this.errorHandler(s,v,r,u,t)});this.on("loading-done",function(){if(!this.views.length){this.trigger("empty-history",this)}})},loadHistoryWithDetails:function(u,t,s,v){this.info("loadHistoryWithDetails:",u,t,s,v);var r=function(w){return _.values(l.get(w.id).get("expandedIds"))};return this.loadHistory(u,t,s,v,r)},loadHistory:function(v,u,t,w,r){this.info("loadHistory:",v,u,t,w,r);var s=this;u=u||{};s.trigger("loading",s);var x=h.History.getHistoryData(v,{historyFn:t,contentsFn:w,detailIdsFn:u.initiallyExpanded||r});return s._loadHistoryFromXHR(x,u).fail(function(A,y,z){s.trigger("error",s,A,u,g("An error was encountered while "+y),{historyId:v,history:z||{}})}).always(function(){s.trigger("loading-done",s)})},_loadHistoryFromXHR:function(t,s){var r=this;t.then(function(u,v){r.JSONToModel(u,v,s);r.render()});t.fail(function(v,u){r.render()});return t},refreshContents:function(s,r){if(this.model){return this.model.refresh(s,r)}return $.when()},JSONToModel:function(u,r,s){this.log("JSONToModel:",u,r,s);s=s||{};var t=new h.History(u,r,s);this.setModel(t);return t},setModel:function(s,r){r=r||{};p.prototype.setModel.call(this,s,r);if(this.model){this._setUpWebStorage(r.initiallyExpanded,r.show_deleted,r.show_hidden)}},_setUpWebStorage:function(s,r,t){if(this.storage){this.stopListening(this.storage)}this.storage=new l({id:l.historyStorageKey(this.model.get("id"))});if(_.isObject(s)){this.storage.set("expandedIds",s)}if(_.isBoolean(r)){this.storage.set("show_deleted",r)}if(_.isBoolean(t)){this.storage.set("show_hidden",t)}this.trigger("new-storage",this.storage,this);this.log(this+" (init'd) storage:",this.storage.get());this.listenTo(this.storage,{"change:show_deleted":function(u,v){this.showDeleted=v},"change:show_hidden":function(u,v){this.showHidden=v}},this);this.showDeleted=(r!==undefined)?r:this.storage.get("show_deleted");this.showHidden=(t!==undefined)?t:this.storage.get("show_hidden");return this},_buildNewRender:function(){var r=p.prototype._buildNewRender.call(this);if(this.multiselectActions().length){r.find(".controls .actions").prepend(this._renderSelectButton())}return r},_renderSelectButton:function(r){return c({title:g("Operations on multiple datasets"),classes:"show-selectors-btn",faIcon:"fa-check-square-o"})},_getItemViewClass:function(r){var s=r.get("history_content_type");switch(s){case"dataset":return this.HDAViewClass;case"dataset_collection":return this.HDCAViewClass}throw new TypeError("Unknown history_content_type: "+s)},_filterItem:function(s){var r=this;return(p.prototype._filterItem.call(r,s)&&(!s.hidden()||r.showHidden)&&(!s.isDeletedOrPurged()||r.showDeleted))},_getItemViewOptions:function(s){var r=p.prototype._getItemViewOptions.call(this,s);return _.extend(r,{linkTarget:this.linkTarget,expanded:!!this.storage.get("expandedIds")[s.id],hasUser:this.model.ownedByCurrUser()})},_setUpItemViewListeners:function(s){var r=this;p.prototype._setUpItemViewListeners.call(r,s);s.on("expanded",function(t){r.storage.addExpanded(t.model)});s.on("collapsed",function(t){r.storage.removeExpanded(t.model)});return this},getSelectedModels:function(){var r=p.prototype.getSelectedModels.call(this);r.historyId=this.collection.historyId;return r},events:_.extend(_.clone(p.prototype.events),{"click .show-selectors-btn":"toggleSelectors"}),toggleShowDeleted:function(r,s){r=(r!==undefined)?(r):(!this.showDeleted);s=(s!==undefined)?(s):(true);this.showDeleted=r;if(s){this.storage.set("show_deleted",r)}this.trigger("show-hidden",r);this.renderItems();return this.showDeleted},toggleShowHidden:function(r,s){r=(r!==undefined)?(r):(!this.showHidden);s=(s!==undefined)?(s):(true);this.showHidden=r;if(s){this.storage.set("show_hidden",r)}this.trigger("show-hidden",r);this.renderItems();return this.showHidden},_firstSearch:function(r){var s=this,t=".history-search-input";this.log("onFirstSearch",r);if(s.model.contents.haveDetails()){s.searchItems(r);return}s.$el.find(t).searchInput("toggle-loading");s.model.contents.fetchAllDetails({silent:true}).always(function(){s.$el.find(t).searchInput("toggle-loading")}).done(function(){s.searchItems(r)})},errorHandler:function(t,w,s,v,u){this.error(t,w,s,v,u);if(w&&w.status===0&&w.readyState===0){}else{if(w&&w.status===502){}else{var r=this._parseErrorMessage(t,w,s,v,u);if(!this.$messages().is(":visible")){this.once("rendered",function(){this.displayMessage("error",r.message,r.details)})}else{this.displayMessage("error",r.message,r.details)}}}},_parseErrorMessage:function(v,y,z,t,r,w){var u=Galaxy.currUser,x={message:this._bePolite(t),details:{message:t,raven:(window.Raven&&_.isFunction(Raven.lastEventId))?(Raven.lastEventId()):(undefined),agent:navigator.userAgent,url:(window.Galaxy)?(Galaxy.lastAjax.url):(undefined),data:(window.Galaxy)?(Galaxy.lastAjax.data):(undefined),options:(y)?(_.omit(z,"xhr")):(z),xhr:y,source:(_.isFunction(v.toJSON))?(v.toJSON()):(v+""),user:(u instanceof i.User)?(u.toJSON()):(u+"")}};_.extend(x.details,r||{});if(y&&_.isFunction(y.getAllResponseHeaders)){var s=y.getAllResponseHeaders();s=_.compact(s.split("\n"));s=_.map(s,function(A){return A.split(": ")});x.details.xhr.responseHeaders=_.object(s)}return x},_bePolite:function(r){r=r||g("An error occurred while getting updates from the server");return r+". "+g("Please contact a Galaxy administrator if the problem persists")+"."},displayMessage:function(w,x,v){var t=this;this.scrollToTop();var u=this.$messages(),r=$("<div/>").addClass(w+"message").html(x);if(!_.isEmpty(v)){var s=$('<a href="javascript:void(0)">Details</a>').click(function(){Galaxy.modal.show(t._messageToModalOptions(w,x,v));return false});r.append(" ",s)}return u.html(r)},_messageToModalOptions:function(u,x,t){var r=this,s={title:"Details"};if(_.isObject(t)){t=_.omit(t,_.functions(t));var w=JSON.stringify(t,null,"  "),v=$("<pre/>").text(w);s.body=$("<div/>").append(v)}else{s.body=$("<div/>").html(t)}s.buttons={Ok:function(){Galaxy.modal.hide();r.clearMessages()}};return s},clearMessages:function(r){$(r.currentTarget).fadeOut(this.fxSpeed,function(){$(this).remove()});return this},scrollToHid:function(r){return this.scrollToItem(_.first(this.viewsWhereModel({hid:r})))},toString:function(){return"HistoryPanel("+((this.model)?(this.model.get("name")):(""))+")"}});m.prototype.templates=(function(){var r=q.wrapTemplate(['<div class="controls">','<div class="title">','<div class="name"><%= history.name %></div>',"</div>",'<div class="subtitle"></div>','<div class="history-size"><%= history.nice_size %></div>','<div class="actions"></div>','<div class="messages">',"<% if( history.deleted && history.purged ){ %>",'<div class="deleted-msg warningmessagesmall">',g("This history has been purged and deleted"),"</div>","<% } else if( history.deleted ){ %>",'<div class="deleted-msg warningmessagesmall">',g("This history has been deleted"),"</div>","<% } else if( history.purged ){ %>",'<div class="deleted-msg warningmessagesmall">',g("This history has been purged"),"</div>","<% } %>","<% if( history.message ){ %>",'<div class="<%= history.message.level || "info" %>messagesmall">',"<%= history.message.text %>","</div>","<% } %>","</div>",'<div class="tags-display"></div>','<div class="annotation-display"></div>','<div class="search">','<div class="search-input"></div>',"</div>",'<div class="list-actions">','<div class="btn-group">','<button class="select-all btn btn-default"','data-mode="select">',g("All"),"</button>",'<button class="deselect-all btn btn-default"','data-mode="select">',g("None"),"</button>","</div>",'<div class="list-action-menu btn-group">',"</div>","</div>","</div>"],"history");return _.extend(_.clone(p.prototype.templates),{controls:r})}());return{HistoryPanel:m}});