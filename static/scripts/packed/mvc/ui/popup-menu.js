define([],function(){var a=Backbone.View.extend({initialize:function(d,c){this.$button=d;if(!this.$button.size()){this.$button=$("<div/>")}this.options=c||[];var e=this;this.$button.click(function(f){$(".popmenu-wrapper").remove();e._renderAndShow(f);return false})},_renderAndShow:function(c){this.render();this.$el.appendTo("body").css(this._getShownPosition(c)).show();this._setUpCloseBehavior()},render:function(){this.$el.addClass("popmenu-wrapper").hide().css({position:"absolute"}).html(this.template(this.$button.attr("id"),this.options));if(this.options.length){var c=this;this.$el.find("li").each(function(e,d){var f=c.options[e];if(f.func){$(this).children("a.popupmenu-option").click(function(g){f.func.call(c,g,f)})}})}return this},template:function(d,c){return['<ul id="',d,'-menu" class="dropdown-menu">',this._templateOptions(c),"</ul>"].join("")},_templateOptions:function(c){if(!c.length){return"<li>(no options)</li>"}return _.map(c,function(f){if(f.divider){return'<li class="divider"></li>'}else{if(f.header){return['<li class="head"><a href="javascript:void(0);">',f.html,"</a></li>"].join("")}}var e=f.href||"javascript:void(0);",g=(f.target)?(' target="'+f.target+'"'):(""),d=(f.checked)?('<span class="fa fa-check"></span>'):("");return['<li><a class="popupmenu-option" href="',e,'"',g,">",d,f.html,"</a></li>"].join("")}).join("")},_getShownPosition:function(d){var e=this.$el.width();var c=d.pageX-e/2;c=Math.min(c,$(document).scrollLeft()+$(window).width()-e-5);c=Math.max(c,$(document).scrollLeft()+5);return{top:d.pageY,left:c}},_setUpCloseBehavior:function(){var e=this;function c(g){$(document).off("click.close_popup");if(window.parent!==window){try{$(window.parent.document).off("click.close_popup")}catch(f){}}else{try{$("iframe#galaxy_main").contents().off("click.close_popup")}catch(f){}}e.remove()}$("html").one("click.close_popup",c);if(window.parent!==window){try{$(window.parent.document).find("html").one("click.close_popup",c)}catch(d){}}else{try{$("iframe#galaxy_main").contents().one("click.close_popup",c)}catch(d){}}},addItem:function(d,c){c=(c>=0)?c:this.options.length;this.options.splice(c,0,d);return this},removeItem:function(c){if(c>=0){this.options.splice(c,1)}return this},findIndexByHtml:function(d){for(var c=0;c<this.options.length;c++){if(_.has(this.options[c],"html")&&(this.options[c].html===d)){return c}}return null},findItemByHtml:function(c){return this.options[(this.findIndexByHtml(c))]},toString:function(){return"PopupMenu"}});a.create=function b(d,c){return new a(d,c)};a.make_popupmenu=function(d,e){var c=[];_.each(e,function(h,f){var g={html:f};if(h===null){g.header=true}else{if(jQuery.type(h)==="function"){g.func=h}}c.push(g)});return new a($(d),c)};a.convertLinksToOptions=function(e,c){e=$(e);c=c||"a";var d=[];e.find(c).each(function(j,g){var h={},f=$(j);h.html=f.text();if(f.attr("href")){var l=f.attr("href"),m=f.attr("target"),k=f.attr("confirm");h.func=function(){if((k)&&(!confirm(k))){return}switch(m){case"_parent":window.parent.location=l;break;case"_top":window.top.location=l;break;default:window.location=l}}}d.push(h)});return d};a.fromExistingDom=function(f,e,c){f=$(f);e=$(e);var d=a.convertLinksToOptions(e,c);e.remove();return new a(f,d)};a.make_popup_menus=function(e,d,f){e=e||document;d=d||"div[popupmenu]";f=f||function(g,h){return"#"+g.attr("popupmenu")};var c=[];$(e).find(d).each(function(){var g=$(this),h=$(e).find(f(g,e));c.push(a.fromDom(h,g));h.addClass("popup")});return c};return a});