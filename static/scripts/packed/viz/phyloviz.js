define(["libs/d3","viz/visualization","mvc/data","mvc/ui/icon-button"],function(n,g,h,c){var m=Backbone.View.extend({className:"UserMenuBase",isAcceptableValue:function(r,p,o){var s=r.val(),t=r.attr("displayLabel")||r.attr("id").replace("phyloViz","");function q(u){return !isNaN(parseFloat(u))&&isFinite(u)}if(!q(s)){alert(t+" is not a number!");return false}if(s>o){alert(t+" is too large.");return false}else{if(s<p){alert(t+" is too small.");return false}}return true},hasIllegalJsonCharacters:function(o){if(o.val().search(/"|'|\\/)!==-1){alert("Named fields cannot contain these illegal characters: double quote(\"), single guote('), or back slash(\\). ");return true}return false}});function i(){var x=this,s=n.layout.hierarchy().sort(null).value(null),w=360,r="Linear",v=18,t=200,u=0,q=0.5,o=50;x.leafHeight=function(y){if(typeof y==="undefined"){return v}else{v=y;return x}};x.layoutMode=function(y){if(typeof y==="undefined"){return r}else{r=y;return x}};x.layoutAngle=function(y){if(typeof y==="undefined"){return w}if(isNaN(y)||y<0||y>360){return x}else{w=y;return x}};x.separation=function(y){if(typeof y==="undefined"){return t}else{t=y;return x}};x.links=function(y){return n.layout.tree().links(y)};x.nodes=function(B,z){if(toString.call(B)==="[object Array]"){B=B[0]}var A=s.call(x,B,z),y=[],D=0,C=0;window._d=B;window._nodes=A;A.forEach(function(E){D=E.depth>D?E.depth:D;y.push(E)});y.forEach(function(E){if(!E.children){C+=1;E.depth=D}});v=r==="Circular"?w/C:v;u=0;p(y[0],D,v,null);return y};function p(C,E,B,A){var z=C.children,y=0;var D=C.dist||q;D=D>1?1:D;C.dist=D;if(A!==null){C.y0=A.y0+D*t}else{C.y0=o}if(!z){C.x0=u*B;u+=1}else{z.forEach(function(F){F.parent=C;y+=p(F,E,B,C)});C.x0=y/z.length}C.x=C.x0;C.y=C.y0;return C.x0}return x}var b=g.Visualization.extend({defaults:{layout:"Linear",separation:250,leafHeight:18,type:"phyloviz",title:"Title",scaleFactor:1,translate:[0,0],fontSize:12,selectedNode:null,nodeAttrChangedTime:0},initialize:function(o){this.set("dataset",new h.Dataset({id:o.dataset_id}))},root:{},toggle:function(o){if(typeof o==="undefined"){return}if(o.children){o._children=o.children;o.children=null}else{o.children=o._children;o._children=null}},toggleAll:function(o){if(o.children&&o.children.length!==0){o.children.forEach(this.toggleAll);toggle(o)}},getData:function(){return this.root},save:function(){var o=this.root;p(o);function p(r){delete r.parent;if(r._selected){delete r._selected}if(r.children){r.children.forEach(p)}if(r._children){r._children.forEach(p)}}var q=jQuery.extend(true,{},this.attributes);q.selectedNode=null;show_message("Saving to Galaxy","progress");return $.ajax({url:this.url(),type:"POST",dataType:"json",data:{config:JSON.stringify(q),type:"phyloviz"},success:function(r){hide_modal()}})}});var e=Backbone.View.extend({defaults:{nodeRadius:4.5},stdInit:function(p){var o=this;o.model.on("change:separation change:leafHeight change:fontSize change:nodeAttrChangedTime",o.updateAndRender,o);o.vis=p.vis;o.i=0;o.maxDepth=-1;o.width=p.width;o.height=p.height},updateAndRender:function(q){var p=n.select(".vis"),o=this;q=q||o.model.root;o.renderNodes(q);o.renderLinks(q);o.addTooltips()},renderLinks:function(o){var x=this;var p=x.diagonal;var q=x.duration;var s=x.layoutMode;var u=x.vis.selectAll("g.completeLink").data(x.tree.links(x.nodes),function(y){return y.target.id});var w=function(y){y.pos0=y.source.y0+" "+y.source.x0;y.pos1=y.source.y0+" "+y.target.x0;y.pos2=y.target.y0+" "+y.target.x0};var v=u.enter().insert("svg:g","g.node").attr("class","completeLink");v.append("svg:path").attr("class","link").attr("d",function(y){w(y);return"M "+y.pos0+" L "+y.pos1});var t=u.transition().duration(500);t.select("path.link").attr("d",function(y){w(y);return"M "+y.pos0+" L "+y.pos1+" L "+y.pos2});var r=u.exit().remove()},selectNode:function(p){var o=this;n.selectAll("g.node").classed("selectedHighlight",function(q){if(p.id===q.id){if(p._selected){delete p._selected;return false}else{p._selected=true;return true}}return false});o.model.set("selectedNode",p);$("#phyloVizSelectedNodeName").val(p.name);$("#phyloVizSelectedNodeDist").val(p.dist);$("#phyloVizSelectedNodeAnnotation").val(p.annotation||"")},addTooltips:function(){$(".tooltip").remove();$(".node").attr("data-original-title",function(){var p=this.__data__,o=p.annotation||"None";return p?(p.name?p.name+"<br/>":"")+"Dist: "+p.dist+" <br/>Annotation: "+o:""}).tooltip({placement:"top",trigger:"hover"})}});var a=e.extend({initialize:function(p){var o=this;o.margins=p.margins;o.layoutMode="Linear";o.stdInit(p);o.layout();o.updateAndRender(o.model.root)},layout:function(){var o=this;o.tree=new i().layoutMode("Linear");o.diagonal=n.svg.diagonal().projection(function(p){return[p.y,p.x]})},renderNodes:function(o){var v=this,w=v.model.get("fontSize")+"px";v.tree.separation(v.model.get("separation")).leafHeight(v.model.get("leafHeight"));var r=500,p=v.tree.separation(v.model.get("separation")).nodes(v.model.root);var q=v.vis.selectAll("g.node").data(p,function(x){return x.name+x.id||(x.id=++v.i)});v.nodes=p;v.duration=r;var s=q.enter().append("svg:g").attr("class","node").on("dblclick",function(){n.event.stopPropagation()}).on("click",function(x){if(n.event.altKey){v.selectNode(x)}else{if(x.children&&x.children.length===0){return}v.model.toggle(x);v.updateAndRender(x)}});if(toString.call(o)==="[object Array]"){o=o[0]}s.attr("transform",function(x){return"translate("+o.y0+","+o.x0+")"});s.append("svg:circle").attr("r",0.000001).style("fill",function(x){return x._children?"lightsteelblue":"#fff"});s.append("svg:text").attr("class","nodeLabel").attr("x",function(x){return x.children||x._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(x){return x.children||x._children?"end":"start"}).style("fill-opacity",0.000001);var t=q.transition().duration(r);t.attr("transform",function(x){return"translate("+x.y+","+x.x+")"});t.select("circle").attr("r",v.defaults.nodeRadius).style("fill",function(x){return x._children?"lightsteelblue":"#fff"});t.select("text").style("fill-opacity",1).style("font-size",w).text(function(x){return x.name});var u=q.exit().transition().duration(r).remove();u.select("circle").attr("r",0.000001);u.select("text").style("fill-opacity",0.000001);p.forEach(function(x){x.x0=x.x;x.y0=x.y})}});var k=Backbone.View.extend({className:"phyloviz",initialize:function(p){var o=this;o.MIN_SCALE=0.05;o.MAX_SCALE=5;o.MAX_DISPLACEMENT=500;o.margins=[10,60,10,80];o.width=$("#PhyloViz").width();o.height=$("#PhyloViz").height();o.radius=o.width;o.data=p.data;$(window).resize(function(){o.width=$("#PhyloViz").width();o.height=$("#PhyloViz").height();o.render()});o.phyloTree=new b(p.config);o.phyloTree.root=o.data;o.zoomFunc=n.behavior.zoom().scaleExtent([o.MIN_SCALE,o.MAX_SCALE]);o.zoomFunc.translate(o.phyloTree.get("translate"));o.zoomFunc.scale(o.phyloTree.get("scaleFactor"));o.navMenu=new d(o);o.settingsMenu=new j({phyloTree:o.phyloTree});o.nodeSelectionView=new f({phyloTree:o.phyloTree});o.search=new l();setTimeout(function(){o.zoomAndPan()},1000)},render:function(){var p=this;$("#PhyloViz").empty();p.mainSVG=n.select("#PhyloViz").append("svg:svg").attr("width",p.width).attr("height",p.height).attr("pointer-events","all").call(p.zoomFunc.on("zoom",function(){p.zoomAndPan()}));p.boundingRect=p.mainSVG.append("svg:rect").attr("class","boundingRect").attr("width",p.width).attr("height",p.height).attr("stroke","black").attr("fill","white");p.vis=p.mainSVG.append("svg:g").attr("class","vis");p.layoutOptions={model:p.phyloTree,width:p.width,height:p.height,vis:p.vis,margins:p.margins};$("#title").text("Phylogenetic Tree from "+p.phyloTree.get("title")+":");var o=new a(p.layoutOptions)},zoomAndPan:function(o){var u,q;if(typeof o!=="undefined"){u=o.zoom;q=o.translate}var z=this,s=z.zoomFunc.scale(),w=z.zoomFunc.translate(),t="",v="";switch(u){case"reset":s=1;w=[0,0];break;case"+":s*=1.1;break;case"-":s*=0.9;break;default:if(typeof u==="number"){s=u}else{if(n.event!==null){s=n.event.scale}}}if(s<z.MIN_SCALE||s>z.MAX_SCALE){return}z.zoomFunc.scale(s);t="translate("+z.margins[3]+","+z.margins[0]+") scale("+s+")";if(n.event!==null){v="translate("+n.event.translate+")"}else{if(typeof q!=="undefined"){var r=q.split(",")[0];var p=q.split(",")[1];if(!isNaN(r)&&!isNaN(p)){w=[w[0]+parseFloat(r),w[1]+parseFloat(p)]}}z.zoomFunc.translate(w);v="translate("+w+")"}z.phyloTree.set("scaleFactor",s);z.phyloTree.set("translate",w);z.vis.attr("transform",v+t)},reloadViz:function(){var o=this,p=$("#phylovizNexSelector :selected").val();$.getJSON(o.phyloTree.get("dataset").url(),{tree_index:p,data_type:"raw_data"},function(q){o.data=q.data;o.config=q;o.render()})}});var d=Backbone.View.extend({initialize:function(p){var o=this;o.phylovizView=p;$("#panelHeaderRightBtns").empty();$("#phyloVizNavBtns").empty();$("#phylovizNexSelector").off();o.initNavBtns();o.initRightHeaderBtns();$("#phylovizNexSelector").off().on("change",function(){o.phylovizView.reloadViz()})},initRightHeaderBtns:function(){var o=this;rightMenu=c.create_icon_buttons_menu([{icon_class:"gear",title:"PhyloViz Settings",on_click:function(){$("#SettingsMenu").show();o.settingsMenu.updateUI()}},{icon_class:"disk",title:"Save visualization",on_click:function(){var p=$("#phylovizNexSelector option:selected").text();if(p){o.phylovizView.phyloTree.set("title",p)}o.phylovizView.phyloTree.save()}},{icon_class:"chevron-expand",title:"Search / Edit Nodes",on_click:function(){$("#nodeSelectionView").show()}},{icon_class:"information",title:"Phyloviz Help",on_click:function(){window.open("https://wiki.galaxyproject.org/Learn/Visualization/PhylogeneticTree")}}],{tooltip_config:{placement:"bottom"}});$("#panelHeaderRightBtns").append(rightMenu.$el)},initNavBtns:function(){var o=this,p=c.create_icon_buttons_menu([{icon_class:"zoom-in",title:"Zoom in",on_click:function(){o.phylovizView.zoomAndPan({zoom:"+"})}},{icon_class:"zoom-out",title:"Zoom out",on_click:function(){o.phylovizView.zoomAndPan({zoom:"-"})}},{icon_class:"arrow-circle",title:"Reset Zoom/Pan",on_click:function(){o.phylovizView.zoomAndPan({zoom:"reset"})}}],{tooltip_config:{placement:"bottom"}});$("#phyloVizNavBtns").append(p.$el)}});var j=m.extend({className:"Settings",initialize:function(p){var o=this;o.phyloTree=p.phyloTree;o.el=$("#SettingsMenu");o.inputs={separation:$("#phyloVizTreeSeparation"),leafHeight:$("#phyloVizTreeLeafHeight"),fontSize:$("#phyloVizTreeFontSize")};$("#settingsCloseBtn").off().on("click",function(){o.el.hide()});$("#phylovizResetSettingsBtn").off().on("click",function(){o.resetToDefaults()});$("#phylovizApplySettingsBtn").off().on("click",function(){o.apply()})},apply:function(){var o=this;if(!o.isAcceptableValue(o.inputs.separation,50,2500)||!o.isAcceptableValue(o.inputs.leafHeight,5,30)||!o.isAcceptableValue(o.inputs.fontSize,5,20)){return}$.each(o.inputs,function(p,q){o.phyloTree.set(p,q.val())})},updateUI:function(){var o=this;$.each(o.inputs,function(p,q){q.val(o.phyloTree.get(p))})},resetToDefaults:function(){$(".tooltip").remove();var o=this;$.each(o.phyloTree.defaults,function(p,q){o.phyloTree.set(p,q)});o.updateUI()},render:function(){}});var f=m.extend({className:"Settings",initialize:function(p){var o=this;o.el=$("#nodeSelectionView");o.phyloTree=p.phyloTree;o.UI={enableEdit:$("#phylovizEditNodesCheck"),saveChanges:$("#phylovizNodeSaveChanges"),cancelChanges:$("#phylovizNodeCancelChanges"),name:$("#phyloVizSelectedNodeName"),dist:$("#phyloVizSelectedNodeDist"),annotation:$("#phyloVizSelectedNodeAnnotation")};o.valuesOfConcern={name:null,dist:null,annotation:null};$("#nodeSelCloseBtn").off().on("click",function(){o.el.hide()});o.UI.saveChanges.off().on("click",function(){o.updateNodes()});o.UI.cancelChanges.off().on("click",function(){o.cancelChanges()});(function(q){q.fn.enable=function(r){return q(this).each(function(){if(r){q(this).removeAttr("disabled")}else{q(this).attr("disabled","disabled")}})}})(jQuery);o.UI.enableEdit.off().on("click",function(){o.toggleUI()})},toggleUI:function(){var o=this,p=o.UI.enableEdit.is(":checked");if(!p){o.cancelChanges()}$.each(o.valuesOfConcern,function(q,r){o.UI[q].enable(p)});if(p){o.UI.saveChanges.show();o.UI.cancelChanges.show()}else{o.UI.saveChanges.hide();o.UI.cancelChanges.hide()}},cancelChanges:function(){var o=this,p=o.phyloTree.get("selectedNode");if(p){$.each(o.valuesOfConcern,function(q,r){o.UI[q].val(p[q])})}},updateNodes:function(){var o=this,p=o.phyloTree.get("selectedNode");if(p){if(!o.isAcceptableValue(o.UI.dist,0,1)||o.hasIllegalJsonCharacters(o.UI.name)||o.hasIllegalJsonCharacters(o.UI.annotation)){return}$.each(o.valuesOfConcern,function(q,r){(p[q])=o.UI[q].val()});o.phyloTree.set("nodeAttrChangedTime",new Date())}else{alert("No node selected")}}});var l=m.extend({initialize:function(){var o=this;$("#phyloVizSearchBtn").on("click",function(){var q=$("#phyloVizSearchTerm"),r=$("#phyloVizSearchCondition").val().split("-"),p=r[0],s=r[1];o.hasIllegalJsonCharacters(q);if(p==="dist"){o.isAcceptableValue(q,0,1)}o.searchTree(p,s,q.val())})},searchTree:function(o,q,p){n.selectAll("g.node").classed("searchHighlight",function(s){var r=s[o];if(typeof r!=="undefined"&&r!==null){if(o==="dist"){switch(q){case"greaterEqual":return r>=+p;case"lesserEqual":return r<=+p;default:return}}else{if(o==="name"||o==="annotation"){return r.toLowerCase().indexOf(p.toLowerCase())!==-1}}}})}});return{PhylovizView:k}});